<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>H·ªì s∆° c√° nh√¢n</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f2f5;
      min-height: 100vh;
      padding: 20px;
    }

    .navbar {
      background: #3b82f6;
      color: white;
      padding: 15px 30px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .navbar h1 {
      font-size: 20px;
      font-weight: 600;
    }

    .navbar button {
      background: white;
      color: #3b82f6;
      border: none;
      padding: 8px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.3s;
    }

    .navbar button:hover {
      background: #f0f2f5;
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 30px;
    }

    .profile-header {
      text-align: center;
      padding-bottom: 30px;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 30px;
    }

    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #3b82f6;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      margin: 0 auto 15px;
    }

    .profile-name {
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 5px;
    }

    .profile-role {
      font-size: 14px;
      color: #6b7280;
      background: #f3f4f6;
      padding: 4px 12px;
      border-radius: 12px;
      display: inline-block;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: #374151;
      font-weight: 500;
      margin-bottom: 6px;
      font-size: 14px;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-group input:disabled {
      background: #f9fafb;
      color: #6b7280;
      cursor: not-allowed;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 25px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
    }

    .btn {
      padding: 10px 24px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }

    .btn-secondary:hover {
      background: #e5e7eb;
    }

    .btn-edit {
      background: #10b981;
      color: white;
      padding: 8px 16px;
      font-size: 13px;
    }

    .btn-edit:hover {
      background: #059669;
    }

    .btn:disabled {
      background: #d1d5db;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .alert {
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: none;
      font-size: 14px;
    }

    .alert-success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #6ee7b7;
    }

    .alert-error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .container {
        padding: 20px;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .navbar {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <div class="navbar">
    <h1>üë§ H·ªì s∆° c√° nh√¢n</h1>
    <button onclick="goBack()">‚Üê Quay l·∫°i</button>
  </div>

  <div class="container">
    <div class="profile-header">
      <div class="profile-avatar" id="avatar">üë§</div>
      <div class="profile-name" id="profileName">ƒêang t·∫£i...</div>
      <div class="profile-role" id="profileRole">...</div>
    </div>

    <div id="alertBox" class="alert"></div>

    <form id="profileForm">
      <div class="section-title">
        <span>Th√¥ng tin c√° nh√¢n</span>
        <button type="button" class="btn btn-edit" id="btnEdit" onclick="toggleEdit()">‚úèÔ∏è Ch·ªânh s·ª≠a</button>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>M√£ ng∆∞·ªùi d√πng</label>
          <input type="text" id="userCode" disabled>
        </div>
        <div class="form-group">
          <label>Vai tr√≤</label>
          <input type="text" id="userRole" disabled>
        </div>
      </div>

      <div class="form-group">
        <label>H·ªç v√† t√™n</label>
        <input type="text" id="name" disabled required>
      </div>

      <div class="form-group">
        <label>Email</label>
        <input type="email" id="email" disabled>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>S·ªë ƒëi·ªán tho·∫°i</label>
          <input type="tel" id="phone" disabled>
        </div>
        <div class="form-group">
          <label>CMND/CCCD</label>
          <input type="text" id="identityCard" disabled>
        </div>
      </div>

      <div class="form-group">
        <label>ƒê·ªãa ch·ªâ</label>
        <textarea id="address" disabled></textarea>
      </div>

      <div class="btn-group" id="actionButtons" style="display: none;">
        <button type="button" class="btn btn-secondary" onclick="cancelEdit()">H·ªßy</button>
        <button type="submit" class="btn btn-primary">L∆∞u thay ƒë·ªïi</button>
      </div>
    </form>
  </div>

  <script>
    let isEditing = false;
    let originalData = {};

    // Get user from localStorage
    function getUser() {
      const userData = localStorage.getItem('user');
      if (!userData) {
        window.location.href = '/login';
        return null;
      }
      return JSON.parse(userData);
    }

    // Get token
    function getToken() {
      return localStorage.getItem('token');
    }

    // Go back to previous page
    function goBack() {
      const user = getUser();
      if (!user) return;

      if (user.UserRole === 'Manager') {
        window.location.href = '/manager/dashboard';
      } else {
        window.location.href = '/menu';
      }
    }

    // Show alert message
    function showAlert(message, type) {
      const alertBox = document.getElementById('alertBox');
      alertBox.textContent = message;
      alertBox.className = `alert alert-${type}`;
      alertBox.style.display = 'block';

      setTimeout(() => {
        alertBox.style.display = 'none';
      }, 5000);
    }

    // Toggle edit mode
    function toggleEdit() {
      isEditing = true;
      
      // Enable editable fields
      document.getElementById('name').disabled = false;
      document.getElementById('phone').disabled = false;
      document.getElementById('identityCard').disabled = false;
      document.getElementById('address').disabled = false;

      // Show action buttons
      document.getElementById('actionButtons').style.display = 'flex';
      document.getElementById('btnEdit').style.display = 'none';

      // Save original data
      originalData = {
        name: document.getElementById('name').value,
        phone: document.getElementById('phone').value,
        identityCard: document.getElementById('identityCard').value,
        address: document.getElementById('address').value
      };
    }

    // Cancel edit
    function cancelEdit() {
      isEditing = false;

      // Restore original data
      document.getElementById('name').value = originalData.name;
      document.getElementById('phone').value = originalData.phone;
      document.getElementById('identityCard').value = originalData.identityCard;
      document.getElementById('address').value = originalData.address;

      // Disable fields
      document.getElementById('name').disabled = true;
      document.getElementById('phone').disabled = true;
      document.getElementById('identityCard').disabled = true;
      document.getElementById('address').disabled = true;

      // Hide action buttons
      document.getElementById('actionButtons').style.display = 'none';
      document.getElementById('btnEdit').style.display = 'block';
    }

    // Load profile data
    async function loadProfile() {
      const user = getUser();
      const token = getToken();

      if (!user || !token) {
        window.location.href = '/login';
        return;
      }

      // Display user data from localStorage first
      displayUserData(user);

      try {
        // Get fresh data from API
        const response = await fetch('http://127.0.0.1:1234/api/account/profile', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ message: 'L·ªói kh√¥ng x√°c ƒë·ªãnh' }));
          
          // If API fails, keep using localStorage data
          showAlert('‚ö†Ô∏è ƒêang hi·ªÉn th·ªã d·ªØ li·ªáu offline', 'error');
          return;
        }

        const result = await response.json();
        const profileData = result.data;

        // Update with fresh data
        displayUserData(profileData);

        // Update localStorage
        localStorage.setItem('user', JSON.stringify(profileData));

      } catch (error) {
        showAlert('‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi server. Hi·ªÉn th·ªã d·ªØ li·ªáu offline.', 'error');
      }
    }

    // Display user data in the form
    function displayUserData(userData) {
      // Update header
      document.getElementById('profileName').textContent = userData.Name || 'N/A';
      document.getElementById('profileRole').textContent = 
        userData.UserRole === 'Manager' ? 'Qu·∫£n l√Ω' : 'Kh√°ch h√†ng';

      // Update avatar
      const avatar = document.getElementById('avatar');
      avatar.textContent = userData.UserRole === 'Manager' ? 'üë®‚Äçüíº' : 'üë§';

      // Fill form
      document.getElementById('userCode').value = userData.UserCode || '';
      document.getElementById('userRole').value = userData.UserRole || '';
      document.getElementById('name').value = userData.Name || '';
      document.getElementById('email').value = userData.UserEmail || '';
      document.getElementById('phone').value = userData.UserPhone || '';
      document.getElementById('identityCard').value = userData.IdentityCard || '';
      document.getElementById('address').value = userData.UserAddress || '';
    }

    // Handle form submit
    document.getElementById('profileForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const token = getToken();
      if (!token) {
        window.location.href = '/login';
        return;
      }

      // Get form data
      const updateData = {
        Name: document.getElementById('name').value.trim(),
        UserPhone: document.getElementById('phone').value.trim(),
        IdentityCard: document.getElementById('identityCard').value.trim(),
        UserAddress: document.getElementById('address').value.trim()
      };

      // Validation
      if (!updateData.Name) {
        showAlert('Vui l√≤ng nh·∫≠p h·ªç t√™n', 'error');
        return;
      }

      try {
        const response = await fetch('http://127.0.0.1:1234/api/account/profile', {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updateData)
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.message || 'C·∫≠p nh·∫≠t th·∫•t b·∫°i');
        }

        showAlert('‚úÖ C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!', 'success');
        
        // Update localStorage
        const user = getUser();
        const updatedUser = { ...user, ...result.data };
        localStorage.setItem('user', JSON.stringify(updatedUser));

        // Cancel edit mode
        cancelEdit();

        // Reload profile
        await loadProfile();

      } catch (error) {
        console.error('Update profile error:', error);
        showAlert('‚ùå ' + error.message, 'error');
      }
    });

    // Initialize
    loadProfile();
  </script>
</body>
</html>
