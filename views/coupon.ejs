<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Qu·∫£n l√Ω khuy·∫øn m√£i</title>
    <style>
        /* Giao di·ªán t∆∞∆°ng ƒë·ªìng manager-dashboard */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        body {
            font-family: Segoe UI, Tahoma, Verdana, sans-serif;
            background: #f0f7ff;
            min-height: 100vh
        }

        .navbar {
            background: #3b82f6;
            color: #fff;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .navbar h1 {
            font-size: 20px
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px
        }

        .card {
            background: #fff;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.08);
            margin-bottom: 16px
        }

        .controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center
        }

        input[type="text"],
        input[type="number"],
        input[type="datetime-local"],
        textarea,
        select {
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px
        }

        button {
            padding: 10px 14px;
            border-radius: 6px;
            border: none;
            background: #3b82f6;
            color: #fff;
            cursor: pointer;
            font-weight: 600
        }

        button.ghost {
            background: #fff;
            color: #3b82f6;
            border: 1px solid #bfdbfe
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px
        }

        th,
        td {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
            text-align: left
        }

        th {
            background: #f9fafb;
            font-weight: 700;
            color: #374151
        }

        .actions button {
            margin-right: 8px;
            padding: 6px 10px;
            font-size: 13px
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .5);
            align-items: center;
            justify-content: center
        }

        .modal.active {
            display: flex
        }

        .modal-content {
            background: #fff;
            border-radius: 10px;
            max-width: 600px;
            width: 100%;
            padding: 16px
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px
        }

        .msg {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 12px
        }

        .msg.success {
            background: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0
        }

        .msg.error {
            background: #fff1f0;
            color: #9b1c1c;
            border: 1px solid #ffd3d3
        }

        .small {
            font-size: 13px;
            color: #6b7280
        }

        .badge {
            display: inline-block;
            padding: 6px 8px;
            border-radius: 6px;
            font-weight: 600
        }

        .badge.expired {
            background: #fee2e2;
            color: #991b1b
        }

        .badge.active {
            background: #d1fae5;
            color: #065f46
        }
    </style>
</head>

<body>
    <div class="navbar">
        <h1>üéØ Qu·∫£n l√Ω Khuy·∫øn m√£i</h1>
        <div>
            <span id="userName" class="small">ƒêang t·∫£i...</span>
            <button onclick="window.location.href='/manager-dashboard'" style="margin-left:12px">‚Üê Quay l·∫°i Dashboard</button>
            <button onclick="logout()" style="margin-left:12px">ƒêƒÉng xu·∫•t</button>
        </div>
    </div>

    <div class="container">
        <div id="alertContainer"></div>

        <div class="card">
            <div class="controls">
                <input type="text" id="q" placeholder="T√¨m theo m√¥ t·∫£..." style="min-width:260px">
                <button onclick="applySearch()">T√¨m</button>
                <button class="ghost" onclick="resetSearch()">ƒê·∫∑t l·∫°i</button>
                <div style="flex:1"></div>
                <button onclick="openAddModal()">+ Th√™m Khuy·∫øn m√£i</button>
            </div>

            <div id="listArea">
                <div class="small" style="margin-top:12px">ƒêang t·∫£i danh s√°ch...</div>
            </div>
        </div>
    </div>

    <!-- Modal Add/Edit -->
    <div id="modal" class="modal" aria-hidden="true">
        <div class="modal-content">
            <h3 id="modalTitle">Th√™m khuy·∫øn m√£i</h3>
            <div id="modalMsg"></div>

            <form id="promoForm">
                <div class="form-row">
                    <div>
                        <label>Gi·∫£m (VND / s·ªë) <span class="small">*</span></label>
                        <input id="DiscountAmount" type="number" min="0" step="0.01" required>
                    </div>
                    <div>
                        <label>Ng√†y h·∫øt h·∫°n <span class="small">*</span></label>
                        <input id="ExpirationDate" type="datetime-local" required>
                    </div>
                </div>

                <div style="margin-top:12px">
                    <label>M√¥ t·∫£</label>
                    <textarea id="Description" rows="3" style="width:100%;"></textarea>
                </div>

                <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
                    <button type="button" class="ghost" onclick="closeModal()">H·ªßy</button>
                    <button id="saveBtn" type="submit">L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Ki·ªÉm tra auth + role NGAY L·∫¨P T·ª®C tr∆∞·ªõc khi g·ªçi b·∫•t k·ª≥ API n√†o
        const user = (() => {
            try { return JSON.parse(localStorage.getItem('user') || '{}'); } catch (e) { return {}; }
        })();
        const token = localStorage.getItem('token');

        if (!token || !user || !user.UserRole || !['Admin', 'Manager'].includes(user.UserRole)) {
            // N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p ho·∫∑c kh√¥ng ƒë·ªß quy·ªÅn -> chuy·ªÉn v·ªÅ login
            // Gi·ªØ client-side redirect gi·ªëng menu.ejs, kh√¥ng thay ƒë·ªïi auth middleware
            window.location.href = '/login';
        } else {
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('userName').textContent = user.Name || user.UserEmail || user.UserCode || user._id;
            });
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }

        let editingId = null;
        const listArea = document.getElementById('listArea');
        const alertContainer = document.getElementById('alertContainer');

        function showAlert(msg, type = 'success', timeout = 3000) {
            alertContainer.innerHTML = `<div class="msg ${type === 'error' ? 'error' : 'success'}">${msg}</div>`;
            setTimeout(() => alertContainer.innerHTML = '', timeout);
        }

        // Load promotions (ch·ªâ g·ªçi khi ƒë√£ c√≥ token)
        async function loadPromotions() {
            listArea.innerHTML = '<div class="small" style="margin-top:12px">ƒêang t·∫£i danh s√°ch...</div>';
            const q = (new URLSearchParams({ q: document.getElementById('q').value || '' })).toString();
            try {
                const res = await fetch('/api/coupons?' + q, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.status === 401 || res.status === 403) {
                    // token invalid/expired -> redirect v·ªÅ login
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = '/login';
                    return;
                }
                if (!res.ok) {
                    const data = await res.json().catch(() => ({ message: res.statusText }));
                    listArea.innerHTML = `<div class="small">L·ªói: ${data.message || res.statusText}</div>`;
                    return;
                }
                const data = await res.json();
                renderList(data);
            } catch (err) {
                console.error(err);
                listArea.innerHTML = `<div class="small">L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.</div>`;
            }
        }

        function renderList(items) {
            if (!items || items.length === 0) {
                listArea.innerHTML = `<div class="small" style="margin-top:12px">Ch∆∞a c√≥ khuy·∫øn m√£i n√†o.</div>`;
                return;
            }
            const rows = items.map(it => {
                const exp = it.ExpirationDate ? new Date(it.ExpirationDate) : null;
                const isExpired = exp ? (new Date() > exp) : false;
                return `
        <tr>
          <td>${it._id}</td>
          <td>${it.Description || ''}</td>
          <td>${Number(it.DiscountAmount).toLocaleString('vi-VN')} </td>
          <td>${exp ? exp.toLocaleString() : '-'}</td>
          <td>${isExpired ? '<span class="badge expired">ƒê√£ h·∫øt h·∫°n</span>' : '<span class="badge active">C√≤n h·∫°n</span>'}</td>
          <td class="actions">
            <button class="ghost" onclick="openEditModal('${it._id}')">‚úèÔ∏è S·ª≠a</button>
            <button onclick="deletePromo('${it._id}', '${(it.Description || '').replace(/'/g, '\\\'')}')">üóëÔ∏è X√≥a</button>
          </td>
        </tr>
      `;
            }).join('');

            listArea.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>ID</th><th>M√¥ t·∫£</th><th>Gi·∫£m</th><th>H·∫øt h·∫°n</th><th>Tr·∫°ng th√°i</th><th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
        }

        // Modal controls (gi·ªØ nguy√™n logic c≈©)
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMsg = document.getElementById('modalMsg');
        const form = document.getElementById('promoForm');
        const saveBtn = document.getElementById('saveBtn');

        function openAddModal() {
            editingId = null;
            modalTitle.textContent = 'Th√™m khuy·∫øn m√£i';
            modalMsg.innerHTML = '';
            form.reset();
            modal.classList.add('active');
            document.getElementById('DiscountAmount').focus();
        }

        async function openEditModal(id) {
            try {
                const res = await fetch('/api/coupons/' + id, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.status === 401 || res.status === 403) { localStorage.removeItem('token'); localStorage.removeItem('user'); window.location.href = '/login'; return; }
                if (!res.ok) {
                    const d = await res.json().catch(() => ({ message: res.statusText }));
                    showAlert('Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu: ' + (d.message || res.statusText), 'error');
                    return;
                }
                const data = await res.json();
                editingId = id;
                modalTitle.textContent = 'Ch·ªânh s·ª≠a khuy·∫øn m√£i';
                document.getElementById('DiscountAmount').value = data.DiscountAmount;
                if (data.ExpirationDate) {
                    const dt = new Date(data.ExpirationDate);
                    const local = new Date(dt.getTime() - dt.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                    document.getElementById('ExpirationDate').value = local;
                } else document.getElementById('ExpirationDate').value = '';
                document.getElementById('Description').value = data.Description || '';
                modal.classList.add('active');
            } catch (err) {
                console.error(err);
                showAlert('L·ªói t·∫£i d·ªØ li·ªáu', 'error');
            }
        }

        function closeModal() {
            modal.classList.remove('active');
            editingId = null;
            form.reset();
        }

        form.addEventListener('submit', async function (e) {
            e.preventDefault();
            modalMsg.innerHTML = '';
            saveBtn.disabled = true;
            saveBtn.textContent = 'ƒêang x·ª≠ l√Ω...';

            const payload = {
                DiscountAmount: document.getElementById('DiscountAmount').value,
                ExpirationDate: (function () {
                    const v = document.getElementById('ExpirationDate').value;
                    return v ? new Date(v).toISOString() : null;
                })(),
                Description: document.getElementById('Description').value.trim()
            };

            const errors = [];
            if (payload.DiscountAmount === '' || isNaN(Number(payload.DiscountAmount)) || Number(payload.DiscountAmount) < 0) {
                errors.push('DiscountAmount h·ª£p l·ªá >= 0');
            }
            if (!payload.ExpirationDate) errors.push('ExpirationDate l√† b·∫Øt bu·ªôc');

            if (errors.length) {
                modalMsg.innerHTML = `<div class="msg error">${errors.join(', ')}</div>`;
                saveBtn.disabled = false;
                saveBtn.textContent = 'L∆∞u';
                return;
            }

            try {
                const url = editingId ? '/api/coupons/' + editingId : '/api/coupons';
                const method = editingId ? 'PUT' : 'POST';
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(payload)
                });
                if (res.status === 401 || res.status === 403) { localStorage.removeItem('token'); localStorage.removeItem('user'); window.location.href = '/login'; return; }
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    modalMsg.innerHTML = `<div class="msg error">${data.message || (data.errors ? JSON.stringify(data.errors) : res.statusText)}</div>`;
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'L∆∞u';
                    return;
                }
                showAlert(editingId ? 'C·∫≠p nh·∫≠t th√†nh c√¥ng' : 'T·∫°o khuy·∫øn m√£i th√†nh c√¥ng');
                closeModal();
                loadPromotions();
            } catch (err) {
                console.error(err);
                modalMsg.innerHTML = `<div class="msg error">L·ªói k·∫øt n·ªëi</div>`;
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'L∆∞u';
            }
        });

        async function deletePromo(id, desc) {
            if (!confirm(`X√°c nh·∫≠n x√≥a khuy·∫øn m√£i: "${desc || id}"? (x√≥a m·ªÅm)`)) return;
            try {
                const res = await fetch('/api/coupons/' + id, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.status === 401 || res.status === 403) { localStorage.removeItem('token'); localStorage.removeItem('user'); window.location.href = '/login'; return; }
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    showAlert(data.message || 'X√≥a th·∫•t b·∫°i', 'error');
                    return;
                }
                showAlert('X√≥a th√†nh c√¥ng');
                loadPromotions();
            } catch (err) {
                console.error(err);
                showAlert('L·ªói k·∫øt n·ªëi', 'error');
            }
        }

        function applySearch() { loadPromotions(); }
        function resetSearch() { document.getElementById('q').value = ''; loadPromotions(); }

        // Ch·ªâ g·ªçi init khi ƒë√£ c√≥ token h·ª£p l·ªá (ƒë√£ ki·ªÉm tra ·ªü ƒë·∫ßu)
        (function init() { loadPromotions(); })();
    </script>
</body>
</html>